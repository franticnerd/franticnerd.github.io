<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Spark Application Learning Objectives
 Prepare data for machine learning applications. Save/load constructed data to external storage.   In this section, we will show how to prepare suitable data for building predictive models to predict heart failure (HF). We will first briefly introduce data types involved. Then we show how to construct training/testing samples from the input data using Spark. Finally we will export data in suitable format for modeling later."><meta property="og:title" content="" />
<meta property="og:description" content="Spark Application Learning Objectives
 Prepare data for machine learning applications. Save/load constructed data to external storage.   In this section, we will show how to prepare suitable data for building predictive models to predict heart failure (HF). We will first briefly introduce data types involved. Then we show how to construct training/testing samples from the input data using Spark. Finally we will export data in suitable format for modeling later." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://franticnerd.github.io/bigdata-bootcamp/docs/sessions/spark-application/" />

<title>Spark Application | GT Big Data Bootcamp</title>
<link rel="icon" href="/bigdata-bootcamp/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/bigdata-bootcamp/book.min.63eb88daa545365405ecdbb21033286a325c60a36cfa6d22d21e7c3bc9286941.css" integrity="sha256-Y&#43;uI2qVFNlQF7NuyEDMoajJcYKNs&#43;m0i0h58O8koaUE=">


<script defer src="/bigdata-bootcamp/en.search.min.893faf5011e462c05924d1cdb6f65ce2425a1693f23cd9a0bf9a1c9e26c79afd.js" integrity="sha256-iT&#43;vUBHkYsBZJNHNtvZc4kJaFpPyPNmgv5ocnibHmv0="></script>

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/bigdata-bootcamp"><span>GT Big Data Bootcamp</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  

  
  





 
  
    




  
  <ul>
    
      
        

  <li class="book-section-flat" >
    

  
  <span>Environment</span>
  


    




  
  <ul>
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/environment/env-aws-docker/" class="">Env Aws Docker</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/environment/env-azure-docker/" class="">Env Azure Docker</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/environment/env-docker-compose/" class="">Env Docker Compose</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/environment/env-local-docker-linux/" class="">Env Local Docker Linux</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/environment/env-local-docker-macos/" class="">Env Local Docker Macos</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/environment/env-local-docker-windows/" class="">Env Local Docker Windows</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/environment/env-local-docker/" class="">Env Local Docker</a>
  

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li class="book-section-flat" >
    

  
  <span>Sessions</span>
  


    




  
  <ul>
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/sessions/scala-basic/" class="">Scala Basic</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/sessions/scala-intro/" class="">Scala Intro</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/sessions/spark-application/" class="active">Spark Application</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/sessions/spark-basic/" class="">Spark Basic</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/sessions/spark-graphx/" class="">Spark Graphx</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/sessions/spark-mllib/" class="">Spark Mllib</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/sessions/spark-sql/" class="">Spark Sql</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/sessions/spark/" class="">Spark</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/sessions/zeppelin-intro/" class="">Zeppelin Intro</a>
  

</li>
      
    
      
        <li>

  
  <a href="/bigdata-bootcamp/docs/sessions/zeppelin-tutorial/" class="">Zeppelin Tutorial</a>
  

</li>
      
    
  </ul>
  



  </li>


      
    
  </ul>
  



  
















</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/bigdata-bootcamp/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Spark Application</strong>

  <label for="toc-control">
    <img src="/bigdata-bootcamp/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#data-types">Data Types</a>
      <ul>
        <li><a href="#feature-vector">Feature Vector</a></li>
        <li><a href="#labeled-point">Labeled Point</a></li>
      </ul>
    </li>
    <li><a href="#feature-construction">Feature Construction</a>
      <ul>
        <li><a href="#overview">Overview</a></li>
        <li><a href="#1-load-data">1. Load data</a></li>
        <li><a href="#2-group-patient-data">2. Group patient data</a></li>
        <li><a href="#3-define-target-and-feature-values">3. Define target and feature values</a></li>
        <li><a href="#4-feature-name-to-id">4. Feature name to id</a></li>
        <li><a href="#5-create-final-labeledpoint">5. Create final <code>LabeledPoint</code></a></li>
      </ul>
    </li>
    <li><a href="#save">Save</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="spark-application">Spark Application</h1>
<blockquote class="book-hint info">
  <strong>Learning Objectives</strong></p>
<ul>
<li>Prepare data for machine learning applications.</li>
<li>Save/load constructed data to external storage.</li>
</ul>
</blockquote>

<p>In this section, we will show how to prepare suitable data for building predictive models to predict heart failure (HF). We will first briefly introduce data types involved. Then we show how to construct training/testing samples from the input data using Spark. Finally we will export data in suitable format for modeling later.</p>
<h2 id="data-types">Data Types</h2>
<p>For many machine learning tasks, such as classification, regression, and clustering, a data point is often represented as a feature vector. Each coordinate of the vector corresponds to a particular feature of the data point.</p>
<h3 id="feature-vector">Feature Vector</h3>
<p>MLlib, the machine learning module of Spark, supports two types of vectors: dense and sparse.
A dense vector is basically a <code>Double</code> array of length equals to the dimension of the vector.
If a vector contains only a few non-zero entries, we can then more efficiently represent the vector by a sparse vector with non-zero indices and the corresponding values only.
For example, a vector <code>(1.0, 0.0, 3.0)</code> can be represented in dense format as <code>[1.0, 0.0, 3.0]</code> or in sparse format as <code>(3, [0, 2], [1.0, 3.0])</code>, where 3 is the size of the vector.</p>
<p>The base class of a vector is <code>Vector</code>, and there are two implementations: <code>DenseVector</code> and <code>SparseVector</code>. We recommend using the factory methods implemented in <code>Vectors</code> to create vectors.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">scala<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">import</span> org.apache.spark.mllib.linalg.<span style="color:#f92672">{</span><span style="color:#a6e22e">Vector</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Vectors</span><span style="color:#f92672">}</span>

<span style="color:#75715e">// Create a dense vector (1.0, 0.0, 3.0).
</span><span style="color:#75715e"></span>scala<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">val</span> dv <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Vectors</span><span style="color:#f92672">.</span>dense<span style="color:#f92672">(</span><span style="color:#ae81ff">1.0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0.0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3.0</span><span style="color:#f92672">)</span>

<span style="color:#75715e">// Create a sparse vector (1.0, 0.0, 3.0) by specifying its nonzero entries.
</span><span style="color:#75715e"></span>scala<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">val</span> sv <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Vectors</span><span style="color:#f92672">.</span>sparse<span style="color:#f92672">(</span><span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Seq</span><span style="color:#f92672">((</span><span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1.0</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3.0</span><span style="color:#f92672">)))</span>
</code></pre></div><h3 id="labeled-point">Labeled Point</h3>
<p>A labeled point is a vector, either dense or sparse, associated with a label/prediction target. In Spark MLlib, labeled points are used  as input to supervised learning algorithms. For example, in binary classification like HF prediction, a label should be either 0 or 1. For multiclass classification, labels should be class indices starting from zero: 0, 1, 2, &hellip;. For regression problem like payment prediction, a label is a real-valued number.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">scala<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">import</span> org.apache.spark.mllib.linalg.Vectors
scala<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">import</span> org.apache.spark.mllib.regression.LabeledPoint

<span style="color:#75715e">// Create a labeled point with label 1 and a dense feature vector.
</span><span style="color:#75715e"></span>scala<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">val</span> labeled1 <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">LabeledPoint</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Vectors</span><span style="color:#f92672">.</span>dense<span style="color:#f92672">(</span><span style="color:#ae81ff">1.0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0.0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3.0</span><span style="color:#f92672">))</span>

<span style="color:#75715e">// Create a labeled point with label 0 and a sparse feature vector.
</span><span style="color:#75715e"></span>scala<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">val</span> labeled0 <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">LabeledPoint</span><span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Vectors</span><span style="color:#f92672">.</span>sparse<span style="color:#f92672">(</span><span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Seq</span><span style="color:#f92672">((</span><span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1.0</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3.0</span><span style="color:#f92672">))))</span>
</code></pre></div><h2 id="feature-construction">Feature Construction</h2>
<h3 id="overview">Overview</h3>
<p>To apply machine learning algorithms, we need to transform our data into <code>RDD[LabeledPoint]</code>. This feature construction is similar to what we did in <a href="/hadoop/hadoop-pig.html">Hadoop Pig</a>, but will be more concise since we are programming in Scala on Spark. We will need to consider an one-year prediction window. Specifically, we will only use data one year before HF diagnosis. The figure below depicts relationship between prediction window and target.</p>
<p>We can also specify an observation window, inside which data will be used to construct feature vectors.</p>
<p><img src="./images/prediction-window.jpg" alt="Prediction Window" title="Prediction Window"/></p>
<p>High level steps are depicted as the figure below</p>
<p><img src="./images/mllib-predict-process.jpg" alt="process-overview" title="predictive process"/></p>
<p>Our parallelization will be on <strong>patient level</strong>, i.e. each element in RDD is everything about exactly one patient. Feature and prediction target for each patient is almost independent from the others. Recall that our data file is in the following form:</p>
<pre><code>00013D2EFD8E45D1,DIAG78820,1166,1.0
00013D2EFD8E45D1,DIAGV4501,1166,1.0
00013D2EFD8E45D1,heartfailure,1166,1.0
00013D2EFD8E45D1,DIAG2720,1166,1.0
....
</code></pre><p>Each line is a 4-tuple <code>(patient-id, event-id, timestamp, value)</code>. Suppose now our goal is to predict if a patient will have heart failure. We can use the value associated with the event <code>heartfailure</code> as the label. This value can be either 1.0 (the patient has heart failure) or 0.0 (the patient does not have heart failure). We call a patient with heart failure a <strong>positive example</strong> or <strong>case patient</strong>, and a patient without heart failure a <strong>negative example</strong> or <strong>control patient</strong>.
For example, in the above snippet we can see that patient <code>00013D2EFD8E45D1</code> is a positive example. The file <strong>case.csv</strong> consists of only positive examples, and the file <strong>control.csv</strong> consists of only negative examples.</p>
<p>We will use the values associated with events other than <code>heartfailure</code> to construct feature vector for each patient. Specifically, the length of the feature vector is the number of distinct <code>event-id</code>'s, and each coordinate of the vector stores the aggregated value corresponds to a particular <code>event-id</code>. The values associated with events not shown in the file are assume to be 0. Since each patient typically has only a few hundreds of records (lines) compared to thousands of distinct events, it is more efficient to use <code>SparseVector</code>.
Note that each patient can have multiple records with the same <code>event-id</code>. In this case we sum up the values associated with a same <code>event-id</code> as feature value and use <code>event-id</code> as feature name.</p>
<h3 id="1-load-data">1. Load data</h3>
<p>The file <strong>input/case.csv</strong> consists of only positive examples, and the file <strong>input/control.csv</strong> consists of only negative examples. We will load them together. Since the data will be used more than once, we use <code>cache()</code> to prevent reading in the file multiple times.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Event</span><span style="color:#f92672">(</span>patientId<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> eventId<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> timestamp<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span> value<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Double</span><span style="color:#f92672">)</span>

<span style="color:#66d9ef">val</span> rawData <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>textFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;input/&#34;</span><span style="color:#f92672">).</span>
  map<span style="color:#f92672">{</span>line <span style="color:#66d9ef">=&gt;</span>
    <span style="color:#66d9ef">val</span> splits <span style="color:#66d9ef">=</span> line<span style="color:#f92672">.</span>split<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Event</span><span style="color:#f92672">(</span>splits<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">),</span> splits<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">),</span> splits<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">).</span>toInt<span style="color:#f92672">,</span> splits<span style="color:#f92672">(</span><span style="color:#ae81ff">3</span><span style="color:#f92672">).</span>toDouble<span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
</code></pre></div><h3 id="2-group-patient-data">2. Group patient data</h3>
<p>One patient&rsquo;s index date, prediction target etc are independent from another patient, so that we can group by patient-id to put everything about one patient together. When we run <code>map</code> operation, Spark will help us parallelize computation on <strong>patient level</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#75715e">// group raw data with patient id and ignore patient id
</span><span style="color:#75715e">// then we will run parallel on patient lelvel
</span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> grpPatients <span style="color:#66d9ef">=</span> rawData<span style="color:#f92672">.</span>groupBy<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>patientId<span style="color:#f92672">).</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>_2<span style="color:#f92672">)</span>
</code></pre></div><p>The <code>groupBy</code> operation can be illustrated with the example below</p>
<p><img src="./images/application-groupby.jpg" alt="applicaion-groupby" title="Groupby illustrative example"/></p>
<p>Please recall that <code>_._2</code> will return second field of a tuple. In this case it will return the <code>List[event]</code> for a given patient. Finally the <code>grpPatients</code> will be <code>RDD[List[event]]</code></p>
<h3 id="3-define-target-and-feature-values">3. Define target and feature values</h3>
<p>Now, we can practice our <strong>patient level</strong> parallelization. For each patient, we first find the prediction target, which is encoded into an event with name <code>heartfailure</code>, then we identify the index date and keep only useful events before the index date for feature construction. In feature construction, we aggregate the event value into features using <code>sum</code> function and use the event name as the feature name.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> patientTargetAndFeatures <span style="color:#66d9ef">=</span> grpPatients<span style="color:#f92672">.</span>map<span style="color:#f92672">{</span>events <span style="color:#66d9ef">=&gt;</span>
  <span style="color:#75715e">// find event that encode our prediction target, heart failure
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> targetEvent <span style="color:#66d9ef">=</span> events<span style="color:#f92672">.</span>find<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>eventId <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;heartfailure&#34;</span><span style="color:#f92672">).</span>get
  <span style="color:#66d9ef">val</span> target <span style="color:#66d9ef">=</span> targetEvent<span style="color:#f92672">.</span>value

  <span style="color:#75715e">// filter out other events to construct features
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> featureEvents <span style="color:#66d9ef">=</span> events<span style="color:#f92672">.</span>filter<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>eventId <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;heartfailure&#34;</span><span style="color:#f92672">)</span>

  <span style="color:#75715e">// define index date as one year before target
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// and use events happened one year before heart failure
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> indexDate <span style="color:#66d9ef">=</span> targetEvent<span style="color:#f92672">.</span>timestamp <span style="color:#f92672">-</span> <span style="color:#ae81ff">365</span>
  <span style="color:#66d9ef">val</span> filteredFeatureEvents <span style="color:#66d9ef">=</span> featureEvents<span style="color:#f92672">.</span>filter<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>timestamp <span style="color:#f92672">&lt;=</span> indexDate<span style="color:#f92672">)</span>

  <span style="color:#75715e">// aggregate events into features
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> features <span style="color:#66d9ef">=</span> filteredFeatureEvents<span style="color:#f92672">.</span>
    groupBy<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>eventId<span style="color:#f92672">).</span>
    map<span style="color:#f92672">{</span><span style="color:#66d9ef">case</span><span style="color:#f92672">(</span>eventId<span style="color:#f92672">,</span> grpEvents<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>
      <span style="color:#75715e">// user event id as feature name
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">val</span> featureName <span style="color:#66d9ef">=</span> eventId
      <span style="color:#75715e">// event value sum as feature value
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">val</span> featureValue <span style="color:#66d9ef">=</span> grpEvents<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>value<span style="color:#f92672">).</span>sum

      <span style="color:#f92672">(</span>featureName<span style="color:#f92672">,</span> featureValue<span style="color:#f92672">)</span>
    <span style="color:#f92672">}</span>

  <span style="color:#f92672">(</span>target<span style="color:#f92672">,</span> features<span style="color:#f92672">)</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>The construction of target is relatively simple, but the process of constructing features is tricky. The example below show what happened in main body of above <code>map</code> operation to illustrate how <code>features</code> were constructed</p>
<p><img src="./images/application-feature-values.jpg" alt="application-feature-values" title="feature values process"/></p>
<p>Our final <code>filteredFeatureEvents</code> should be <code>RDD[(target, Map[feature-name, feature-value])]</code> and we can verify
that by the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">scala<span style="color:#f92672">&gt;</span> patientTargetAndFeatures<span style="color:#f92672">.</span>take<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">)</span>
res0<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">Double</span>, <span style="color:#66d9ef">scala.collection.immutable.Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>,<span style="color:#66d9ef">Double</span><span style="color:#f92672">])]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Array</span><span style="color:#f92672">((</span><span style="color:#ae81ff">0.0</span><span style="color:#f92672">,</span><span style="color:#a6e22e">Map</span><span style="color:#f92672">(</span><span style="color:#a6e22e">DRUG36987241603</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">60.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG00378181701</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG11517316909</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">20.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG53002055230</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">200.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG23490063206</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG61113074382</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">60.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG58016093000</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">60.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG52604508802</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG58016037228</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">10.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG60491080134</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG51079093119</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">360.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG00228275711</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG63629290803</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">120.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DIAG4011</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">1.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG58016075212</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">90.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG00378412401</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG63629260701</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG00839619116</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG11390002315</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG58016058050</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">60.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG55289082930</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">60.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG36987154502</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG00364095301</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG58016021326</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">180.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG54868593401</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG58016054035</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG64464000105</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG58016076573</span> <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">30.0</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">DRUG00839710006</span><span style="color:#f92672">...</span>
</code></pre></div><h3 id="4-feature-name-to-id">4. Feature name to id</h3>
<p>In the previous step, we computed <code>filteredFeatureEvents</code> as <code>RDD[(target, Map[feature-name, feature-value])]</code>. In order to convert <code>feature-name</code> to some integer id as required by most machine learning modules including MLlib, we will need to collect all unique feauture names and associate them with integer ids.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#75715e">// assign a unique integer id to feature name
</span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> featureMap <span style="color:#66d9ef">=</span> patientTargetAndFeatures<span style="color:#f92672">.</span> <span style="color:#75715e">// RDD[(target, Map[feature-name, feature-value])]
</span><span style="color:#75715e"></span>  flatMap<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>_2<span style="color:#f92672">.</span>keys<span style="color:#f92672">).</span> <span style="color:#75715e">// get all feature names
</span><span style="color:#75715e"></span>  distinct<span style="color:#f92672">.</span> <span style="color:#75715e">// remove duplication
</span><span style="color:#75715e"></span>  collect<span style="color:#f92672">.</span> <span style="color:#75715e">// collect to driver program
</span><span style="color:#75715e"></span>  zipWithIndex<span style="color:#f92672">.</span> <span style="color:#75715e">// assign an integer id
</span><span style="color:#75715e"></span>  toMap <span style="color:#75715e">// convert to Map[feature-name, feature-id]
</span></code></pre></div><p>Here we used an operation named <code>flatMap</code>. Below is an example, and we can think of <code>flatMap</code> as a two step operation, map and flatten. As a result, <code>patientTargetAndFeatures.flatMap(_._2.keys)</code> will give <code>RDD[feature-name]</code>.</p>
<p><img src="./images/application-flatMap.jpg" alt="flat-map" title="Flat map"/></p>
<p>Next we visualize the steps after <code>flatMap</code>:</p>
<p><img src="./images/application-name-2-id.jpg" alt="application-name-2-id.jpg" title="name to id"/></p>
<p>Here <code>collect</code> is not depicted but what <code>collect</code> does is to collect data from distributed to centralized storage on the driver. Here we assume the resulting data matrix is not too big. If the data matrix is very big, alternative approach may be required such as join.
Note that many the common functions like <code>zipWithIndex</code> have the same name on <code>RDD</code> and on common local data structures like <code>List</code>.</p>
<blockquote class="book-hint info">
  If you get confused about result of certain operations, you can avoid chain of operation calls and instead print out the result of each step.
</blockquote>

<h3 id="5-create-final-labeledpoint">5. Create final <code>LabeledPoint</code></h3>
<p>In this last step, we transform <code>(target, features)</code> for each patient into  <code>LabeledPoint</code>. Basically, we just need to translate feature name in <code>features</code> into feautre id and create a feature vector then associate the vector with <code>target</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#75715e">// broadcast feature map from driver to all workers
</span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> scFeatureMap <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>broadcast<span style="color:#f92672">(</span>featureMap<span style="color:#f92672">)</span>
<span style="color:#66d9ef">val</span> finalSamples <span style="color:#66d9ef">=</span> patientTargetAndFeatures<span style="color:#f92672">.</span>map <span style="color:#f92672">{</span><span style="color:#66d9ef">case</span><span style="color:#f92672">(</span>target<span style="color:#f92672">,</span> features<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>
  <span style="color:#66d9ef">val</span> numFeature <span style="color:#66d9ef">=</span> scFeatureMap<span style="color:#f92672">.</span>value<span style="color:#f92672">.</span>size
  <span style="color:#66d9ef">val</span> indexedFeatures <span style="color:#66d9ef">=</span> features<span style="color:#f92672">.</span>
    toList<span style="color:#f92672">.</span>
    <span style="color:#75715e">// map feature name to id to get List[(feature-id, feature-value)]
</span><span style="color:#75715e"></span>    map<span style="color:#f92672">{</span><span style="color:#66d9ef">case</span><span style="color:#f92672">(</span>featureName<span style="color:#f92672">,</span> featureValue<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">(</span>scFeatureMap<span style="color:#f92672">.</span>value<span style="color:#f92672">(</span>featureName<span style="color:#f92672">),</span> featureValue<span style="color:#f92672">)}</span>

    <span style="color:#66d9ef">val</span> featureVector <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Vectors</span><span style="color:#f92672">.</span>sparse<span style="color:#f92672">(</span>numFeature<span style="color:#f92672">,</span> indexedFeatures<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">val</span> labeledPoint <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">LabeledPoint</span><span style="color:#f92672">(</span>target<span style="color:#f92672">,</span> featureVector<span style="color:#f92672">)</span>
    labeledPoint
<span style="color:#f92672">}</span>
</code></pre></div><p>Here in above example, we called <code>sc.broadcast</code>. As indicated by its name, this function is used for broadcasting data from driver to workers so that workers will not need to copy on demand and waste bandwidth thus slow down the process. Its usage is very simple, call <code>val broadcasted = sc.broadcast(object)</code> and use <code>broadcasted.value</code> to access original <code>object</code>. Please be aware of the fact that such broadcasted object is read-only.</p>
<h2 id="save">Save</h2>
<p>With data readily available as <code>RDD[LabeledPoint]</code>, we can save it into a common format accepted by a lot of machine learning modules, the LibSVM/svmlight format, named after LibSVM/svmlight package.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">import</span> org.apache.spark.mllib.util.MLUtils
<span style="color:#a6e22e">MLUtils</span><span style="color:#f92672">.</span>saveAsLibSVMFile<span style="color:#f92672">(</span>finalSamples<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;samples&#34;</span><span style="color:#f92672">)</span>
</code></pre></div><p><!-- raw HTML omitted --></p>
<p>You can achieve this by</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> mapping <span style="color:#66d9ef">=</span> featureMap<span style="color:#f92672">.</span>
  toList<span style="color:#f92672">.</span>
  sortBy<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>_2<span style="color:#f92672">).</span>
  map<span style="color:#f92672">(</span>pair <span style="color:#66d9ef">=&gt;</span> <span style="color:#e6db74">s&#34;</span><span style="color:#e6db74">${</span>pair<span style="color:#f92672">.</span>_1<span style="color:#e6db74">}</span><span style="color:#e6db74">|</span><span style="color:#e6db74">${</span>pair<span style="color:#f92672">.</span>_2<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">).</span> <span style="color:#75715e">// intentionally use special seperator
</span><span style="color:#75715e"></span>  mkString<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#f92672">)</span>


scala<span style="color:#f92672">.</span>tools<span style="color:#f92672">.</span>nsc<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span><span style="color:#a6e22e">File</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;mapping.txt&#34;</span><span style="color:#f92672">).</span>writeAll<span style="color:#f92672">(</span>mapping<span style="color:#f92672">)</span>
</code></pre></div><!-- raw HTML omitted -->
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#data-types">Data Types</a>
      <ul>
        <li><a href="#feature-vector">Feature Vector</a></li>
        <li><a href="#labeled-point">Labeled Point</a></li>
      </ul>
    </li>
    <li><a href="#feature-construction">Feature Construction</a>
      <ul>
        <li><a href="#overview">Overview</a></li>
        <li><a href="#1-load-data">1. Load data</a></li>
        <li><a href="#2-group-patient-data">2. Group patient data</a></li>
        <li><a href="#3-define-target-and-feature-values">3. Define target and feature values</a></li>
        <li><a href="#4-feature-name-to-id">4. Feature name to id</a></li>
        <li><a href="#5-create-final-labeledpoint">5. Create final <code>LabeledPoint</code></a></li>
      </ul>
    </li>
    <li><a href="#save">Save</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












