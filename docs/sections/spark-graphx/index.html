<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Spark GraphX ::: tip Learning Objectives
 Understand composition of a graph in Spark GraphX. Being able to create a graph. Being able to use the built-in graph algorithm.  :::
In this section we begin by creating a graph with patient and diagnostic codes. Later we will show how to run graph algorithms on the the graph you will create.
Basic concept Spark GraphX abstracts a graph as a concept named Property Graph, which means that each edge and vertex is associated with some properties."><meta property="og:title" content="" />
<meta property="og:description" content="Spark GraphX ::: tip Learning Objectives
 Understand composition of a graph in Spark GraphX. Being able to create a graph. Being able to use the built-in graph algorithm.  :::
In this section we begin by creating a graph with patient and diagnostic codes. Later we will show how to run graph algorithms on the the graph you will create.
Basic concept Spark GraphX abstracts a graph as a concept named Property Graph, which means that each edge and vertex is associated with some properties." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/sections/spark-graphx/" />

<title>Spark Graphx | GT Big Data Bootcamp</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.63eb88daa545365405ecdbb21033286a325c60a36cfa6d22d21e7c3bc9286941.css" integrity="sha256-Y&#43;uI2qVFNlQF7NuyEDMoajJcYKNs&#43;m0i0h58O8koaUE=">


<script defer src="/en.search.min.02e7b0823ad8dc02444c3cf834999439728ff3cbbc9a2ab0061f1409d34848fa.js" integrity="sha256-AuewgjrY3AJETDz4NJmUOXKP88u8miqwBh8UCdNISPo="></script>

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>GT Big Data Bootcamp</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  

  
  





 
  
    




  
  <ul>
    
      
        

  <li class="book-section-flat" >
    

  
  <a href="/docs/example/" class="">Example Site</a>
  


    




  
  <ul>
    
      
        

  <li>
    

  
  <a href="/docs/example/table-of-contents/" class="">Table of Contents</a>
  


    




  
  <ul>
    
      
        <li>

  
  <a href="/docs/example/table-of-contents/with-toc/" class="">With ToC</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/example/table-of-contents/without-toc/" class="">Without ToC</a>
  

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li>
    

  
  <a href="/docs/example/collapsed/" class="collapsed ">Collapsed</a>
  


    






  </li>


      
    
  </ul>
  



  </li>


      
    
      
        

  <li class="book-section-flat" >
    

  
  <span>Shortcodes</span>
  


    




  
  <ul>
    
      
        <li>

  
  <a href="/docs/shortcodes/buttons/" class="">Buttons</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/shortcodes/columns/" class="">Columns</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/shortcodes/expand/" class="">Expand</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/shortcodes/hints/" class="">Hints</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/shortcodes/katex/" class="">Katex</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/shortcodes/mermaid/" class="">Mermaid</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/shortcodes/tabs/" class="">Tabs</a>
  

</li>
      
    
  </ul>
  



  </li>


      
    
  </ul>
  



  
















</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Spark Graphx</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#basic-concept">Basic concept</a></li>
    <li><a href="#graph-construction">Graph construction</a>
      <ul>
        <li><a href="#define-class">Define class</a></li>
        <li><a href="#load-raw-data">Load raw data</a></li>
        <li><a href="#create-vertex">Create vertex</a></li>
        <li><a href="#create-edge">Create edge</a></li>
        <li><a href="#assemble-vertex-and-edge">Assemble vertex and edge</a></li>
      </ul>
    </li>
    <li><a href="#graph-operation">Graph operation</a>
      <ul>
        <li><a href="#connected-components">Connected components</a></li>
        <li><a href="#degree">Degree</a></li>
        <li><a href="#pagerank">PageRank</a></li>
      </ul>
    </li>
    <li><a href="#application">Application</a>
      <ul>
        <li><a href="#explore-comorbidities">Explore comorbidities</a></li>
        <li><a href="#similar-patients">Similar patients</a></li>
      </ul>
    </li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="spark-graphx">Spark GraphX</h1>
<p>::: tip Learning Objectives</p>
<ul>
<li>Understand composition of a graph in Spark GraphX.</li>
<li>Being able to create a graph.</li>
<li>Being able to use the built-in graph algorithm.</li>
</ul>
<p>:::</p>
<p>In this section we begin by creating a graph with patient and diagnostic codes. Later we will show how to run graph algorithms on the the graph you will create.</p>
<h2 id="basic-concept">Basic concept</h2>
<p>Spark GraphX abstracts a graph as a concept named <strong>Property Graph</strong>, which means that each edge and vertex is associated with some properties. The <code>Graph</code> class has the following definition</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Graph</span><span style="color:#f92672">[</span><span style="color:#66d9ef">VD</span>, <span style="color:#66d9ef">ED</span><span style="color:#f92672">]</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">val</span> vertices<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">VertexRDD</span><span style="color:#f92672">[</span><span style="color:#66d9ef">VD</span><span style="color:#f92672">]</span>
  <span style="color:#66d9ef">val</span> edges<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">EdgeRDD</span><span style="color:#f92672">[</span><span style="color:#66d9ef">ED</span><span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Where <code>VD</code> and <code>ED</code> define property types of each vertex and edge respectively. We can regard <code>VertexRDD[VD]</code> as RDD of <code>(VertexID, VD)</code> tuple and <code>EdgeRDD[ED]</code> as RDD of <code>(VertexID, VertexID, ED)</code>.</p>
<h2 id="graph-construction">Graph construction</h2>
<p>Let&rsquo;s create a graph of patients and diagnostic codes. For each patient we can assign its patient id as vertex property, and for each diagnostic code, we will use the code as vertex property. For the edge between patient and diagnostic code, we will use number of times the patient is diagnosed with given disease as edge property.</p>
<h3 id="define-class">Define class</h3>
<p>Let&rsquo;s first define  necessary data structure and import</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">import</span> org.apache.spark.SparkContext._
<span style="color:#66d9ef">import</span> org.apache.spark.graphx._
<span style="color:#66d9ef">import</span> org.apache.spark.rdd.RDD

<span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VertexProperty</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Serializable</span>

<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PatientProperty</span><span style="color:#f92672">(</span>patientId<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">VertexProperty</span>

<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DiagnosticProperty</span><span style="color:#f92672">(</span>icd9code<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">VertexProperty</span>

<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PatientEvent</span><span style="color:#f92672">(</span>patientId<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> eventName<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> date<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span> value<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Double</span><span style="color:#f92672">)</span>
</code></pre></div><h3 id="load-raw-data">Load raw data</h3>
<p>Load patient event data and filter out diagnostic related events only</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> allEvents <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>textFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;data/&#34;</span><span style="color:#f92672">).</span>
  map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>split<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">)).</span>
  map<span style="color:#f92672">(</span>splits <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">PatientEvent</span><span style="color:#f92672">(</span>splits<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">),</span> splits<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">),</span> splits<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">).</span>toInt<span style="color:#f92672">,</span> splits<span style="color:#f92672">(</span><span style="color:#ae81ff">3</span><span style="color:#f92672">).</span>toDouble<span style="color:#f92672">))</span>

<span style="color:#75715e">// get and cache diagnosticEvents as we will reuse
</span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> diagnosticEvents <span style="color:#66d9ef">=</span> allEvents<span style="color:#f92672">.</span>
  filter<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>eventName<span style="color:#f92672">.</span>startsWith<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;DIAG&#34;</span><span style="color:#f92672">)).</span>cache<span style="color:#f92672">()</span>
</code></pre></div><h3 id="create-vertex">Create vertex</h3>
<h4 id="patient-vertex">Patient vertex</h4>
<p>Let&rsquo;s create patient vertex</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#75715e">// create patient vertex
</span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> patientVertexIdRDD <span style="color:#66d9ef">=</span> diagnosticEvents<span style="color:#f92672">.</span>
  map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>patientId<span style="color:#f92672">).</span>
  distinct<span style="color:#f92672">.</span>      <span style="color:#75715e">// get distinct patient ids
</span><span style="color:#75715e"></span>  zipWithIndex     <span style="color:#75715e">// assign an index as vertex id
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">val</span> patient2VertexId <span style="color:#66d9ef">=</span> patientVertexIdRDD<span style="color:#f92672">.</span>collect<span style="color:#f92672">.</span>toMap
<span style="color:#66d9ef">val</span> patientVertex <span style="color:#66d9ef">=</span> patientVertexIdRDD<span style="color:#f92672">.</span>
  map<span style="color:#f92672">{</span><span style="color:#66d9ef">case</span><span style="color:#f92672">(</span>patientId<span style="color:#f92672">,</span> index<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">(</span>index<span style="color:#f92672">,</span> <span style="color:#a6e22e">PatientProperty</span><span style="color:#f92672">(</span>patientId<span style="color:#f92672">))}.</span>
  asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">RDD</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">VertexId</span>, <span style="color:#66d9ef">VertexProperty</span><span style="color:#f92672">)]]</span>
</code></pre></div><p>In order to use the newly created vertex id, we finally <code>collect</code> all the patient to <code>VertrexID</code> mapping.</p>
<p>::: warning</p>
<p>Theoretically, collecting RDD to driver is not an efficient practice. One can obtain uniqueness of ID by calculating ID directly with a Hash.</p>
<p>:::</p>
<h4 id="diagnostic-code-vertex">Diagnostic code vertex</h4>
<p>Similar to patient vertex, we can create diagnostic code vertex with</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#75715e">// create diagnostic code vertex
</span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> startIndex <span style="color:#66d9ef">=</span> patient2VertexId<span style="color:#f92672">.</span>size
<span style="color:#66d9ef">val</span> diagnosticVertexIdRDD <span style="color:#66d9ef">=</span> diagnosticEvents<span style="color:#f92672">.</span>
  map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>eventName<span style="color:#f92672">).</span>
  distinct<span style="color:#f92672">.</span>
  zipWithIndex<span style="color:#f92672">.</span>
  map<span style="color:#f92672">{</span><span style="color:#66d9ef">case</span><span style="color:#f92672">(</span>icd9code<span style="color:#f92672">,</span> zeroBasedIndex<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>
    <span style="color:#f92672">(</span>icd9code<span style="color:#f92672">,</span> zeroBasedIndex <span style="color:#f92672">+</span> startIndex<span style="color:#f92672">)}</span> <span style="color:#75715e">// make sure no conflict with patient vertex id
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">val</span> diagnostic2VertexId <span style="color:#66d9ef">=</span> diagnosticVertexIdRDD<span style="color:#f92672">.</span>collect<span style="color:#f92672">.</span>toMap

<span style="color:#66d9ef">val</span> diagnosticVertex <span style="color:#66d9ef">=</span> diagnosticVertexIdRDD<span style="color:#f92672">.</span>
  map<span style="color:#f92672">{</span><span style="color:#66d9ef">case</span><span style="color:#f92672">(</span>icd9code<span style="color:#f92672">,</span> index<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">(</span>index<span style="color:#f92672">,</span> <span style="color:#a6e22e">DiagnosticProperty</span><span style="color:#f92672">(</span>icd9code<span style="color:#f92672">))}.</span>
  asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">RDD</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">VertexId</span>, <span style="color:#66d9ef">VertexProperty</span><span style="color:#f92672">)]]</span>
</code></pre></div><p>Here we assign vertex id by adding the result of <code>zipWithIndex</code> with an offset obtained from previous patient vertex to avoid ID confliction between patient and diagnostic code.</p>
<h3 id="create-edge">Create edge</h3>
<p>In order to create edge, we will need to know vertext id of vertices we just created.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> bcPatient2VertexId <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>broadcast<span style="color:#f92672">(</span>patient2VertexId<span style="color:#f92672">)</span>
<span style="color:#66d9ef">val</span> bcDiagnostic2VertexId <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>broadcast<span style="color:#f92672">(</span>diagnostic2VertexId<span style="color:#f92672">)</span>

<span style="color:#66d9ef">val</span> edges <span style="color:#66d9ef">=</span> diagnosticEvents<span style="color:#f92672">.</span>
  map<span style="color:#f92672">(</span>event <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">((</span>event<span style="color:#f92672">.</span>patientId<span style="color:#f92672">,</span> event<span style="color:#f92672">.</span>eventName<span style="color:#f92672">),</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)).</span>
  reduceByKey<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">_</span><span style="color:#f92672">).</span>
  map<span style="color:#f92672">{</span><span style="color:#66d9ef">case</span><span style="color:#f92672">((</span>patientId<span style="color:#f92672">,</span> icd9code<span style="color:#f92672">),</span> count<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">(</span>patientId<span style="color:#f92672">,</span> icd9code<span style="color:#f92672">,</span> count<span style="color:#f92672">)}.</span>
  map<span style="color:#f92672">{</span><span style="color:#66d9ef">case</span><span style="color:#f92672">(</span>patientId<span style="color:#f92672">,</span> icd9code<span style="color:#f92672">,</span> count<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Edge</span><span style="color:#f92672">(</span>
    bcPatient2VertexId<span style="color:#f92672">.</span>value<span style="color:#f92672">(</span>patientId<span style="color:#f92672">),</span> <span style="color:#75715e">// src id
</span><span style="color:#75715e"></span>    bcDiagnostic2VertexId<span style="color:#f92672">.</span>value<span style="color:#f92672">(</span>icd9code<span style="color:#f92672">),</span> <span style="color:#75715e">// target id
</span><span style="color:#75715e"></span>    count <span style="color:#75715e">// edge property
</span><span style="color:#75715e"></span>  <span style="color:#f92672">)}</span>
</code></pre></div><p>We first broadcast patient and diagnostic code to vertext id mapping. Broadcast can avoid unnecessary copy in distributed setting thus will be more effecient. Then we count occurrence of <code>(patient-id, icd-9-code)</code> pairs with <code>map</code> and <code>reduceByKey</code>, finally we translate them to proper <code>VertexID</code>.</p>
<h3 id="assemble-vertex-and-edge">Assemble vertex and edge</h3>
<p>We will need to put vertices and edges together to create the graph</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> vertices <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>union<span style="color:#f92672">(</span>patientVertex<span style="color:#f92672">,</span> diagnosticVertex<span style="color:#f92672">)</span>
<span style="color:#66d9ef">val</span> graph <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Graph</span><span style="color:#f92672">(</span>vertices<span style="color:#f92672">,</span> edges<span style="color:#f92672">)</span>
</code></pre></div><h2 id="graph-operation">Graph operation</h2>
<p>Given the graph we created, we can run some basic graph operations.</p>
<h3 id="connected-components">Connected components</h3>
<p><a href="https://en.wikipedia.org/wiki/Connected_component_%28graph_theory%29">Connected component</a> can help find disconnected subgraphs. GraphX provides the API to get connected components as below</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> connectedComponents <span style="color:#66d9ef">=</span> graph<span style="color:#f92672">.</span>connectedComponents
</code></pre></div><p>The return result is a graph and assigned components of original graph is stored as <code>VertexProperty</code>. For example</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">scala<span style="color:#f92672">&gt;</span> connectedComponents<span style="color:#f92672">.</span>vertices<span style="color:#f92672">.</span>take<span style="color:#f92672">(</span><span style="color:#ae81ff">5</span><span style="color:#f92672">)</span>
<span style="color:#a6e22e">Array</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">org.apache.spark.graphx.VertexId</span>, <span style="color:#66d9ef">org.apache.spark.graphx.VertexId</span><span style="color:#f92672">)]</span> <span style="color:#66d9ef">=</span> 
<span style="color:#a6e22e">Array</span><span style="color:#f92672">((</span><span style="color:#ae81ff">2556</span><span style="color:#f92672">,</span><span style="color:#ae81ff">0</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">1260</span><span style="color:#f92672">,</span><span style="color:#ae81ff">0</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">1410</span><span style="color:#f92672">,</span><span style="color:#ae81ff">0</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">324</span><span style="color:#f92672">,</span><span style="color:#ae81ff">0</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">180</span><span style="color:#f92672">,</span><span style="color:#ae81ff">0</span><span style="color:#f92672">))</span>
</code></pre></div><p>The first element of the tuple is <code>VertexID</code> identical to original graph. The second element in the tuple is <code>connected component</code> represented by the lowest-numbered <code>VertexID</code> in that component. In above example, five vertices belong to same component.</p>
<p>We can easily get number of connected components using operations on RDD as below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">scala<span style="color:#f92672">&gt;</span> connectedComponents<span style="color:#f92672">.</span>vertices<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>_2<span style="color:#f92672">).</span>distinct<span style="color:#f92672">.</span>collect
<span style="color:#a6e22e">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">org.apache.spark.graphx.VertexId</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Array</span><span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">169</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">239</span><span style="color:#f92672">)</span>
</code></pre></div><h3 id="degree">Degree</h3>
<p>The property graph abstraction of GraphX is a directed graph. It provides computation of in-dgree, out-degree and total degree. For example, we can get degrees as</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> inDegrees <span style="color:#66d9ef">=</span> graph<span style="color:#f92672">.</span>inDegrees
<span style="color:#66d9ef">val</span> outDegrees <span style="color:#66d9ef">=</span> graph<span style="color:#f92672">.</span>outDegrees
<span style="color:#66d9ef">val</span> totalDegrees <span style="color:#66d9ef">=</span> graph<span style="color:#f92672">.</span>degrees
</code></pre></div><h3 id="pagerank">PageRank</h3>
<p>GraphX also provides implementation of the famous <a href="http://en.wikipedia.org/wiki/PageRank">PageRank</a> algorithm, which can compute the &lsquo;importance&rsquo; of a vertex. The graph we generated above is a bipartite graph and not suitable for PageRank. To gve an example of PageRank, we randomly generate a graph and run fixed iteration of PageRank algorithm on it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">import</span> org.apache.spark.graphx.util.GraphGenerators


<span style="color:#66d9ef">val</span> randomGraph<span style="color:#66d9ef">:</span><span style="color:#66d9ef">Graph</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Long</span>, <span style="color:#66d9ef">Int</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> 
   <span style="color:#a6e22e">GraphGenerators</span><span style="color:#f92672">.</span>logNormalGraph<span style="color:#f92672">(</span>sc<span style="color:#f92672">,</span> numVertices <span style="color:#66d9ef">=</span> <span style="color:#ae81ff">100</span><span style="color:#f92672">)</span>


<span style="color:#66d9ef">val</span> pagerank <span style="color:#66d9ef">=</span> randomGraph<span style="color:#f92672">.</span>staticPageRank<span style="color:#f92672">(</span><span style="color:#ae81ff">20</span><span style="color:#f92672">)</span>
</code></pre></div><p>Or, we can run PageRank until converge with tolerance as <code>0.01</code> using <code>randomGraph.pageRank(0.01)</code></p>
<h2 id="application">Application</h2>
<p>Next, we show some how we can ultilize the graph operations to solve some practical problems in the healthcare domain.</p>
<h3 id="explore-comorbidities">Explore comorbidities</h3>
<p><a href="http://en.wikipedia.org/wiki/Comorbidity">Comorbidity</a> is additional disorders co-occuring with primary disease. We know all the case patients have heart failure, we can explore possible comorbidities as below (see comments for more explaination)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#75715e">// get all the case patients
</span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> casePatients <span style="color:#66d9ef">=</span> allEvents<span style="color:#f92672">.</span>
  filter<span style="color:#f92672">(</span>event <span style="color:#66d9ef">=&gt;</span> event<span style="color:#f92672">.</span>eventName <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;heartfailure&#34;</span> <span style="color:#f92672">&amp;&amp;</span> event<span style="color:#f92672">.</span>value <span style="color:#f92672">==</span> <span style="color:#ae81ff">1.0</span><span style="color:#f92672">).</span>
  map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>patientId<span style="color:#f92672">).</span>
  collect<span style="color:#f92672">.</span>
  toSet

<span style="color:#75715e">// broadcast
</span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> scCasePatients <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>broadcast<span style="color:#f92672">(</span>casePatients<span style="color:#f92672">)</span>

<span style="color:#75715e">//filter the graph with subGraph operation
</span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> filteredGraph <span style="color:#66d9ef">=</span> graph<span style="color:#f92672">.</span>subgraph<span style="color:#f92672">(</span>vpred <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span><span style="color:#66d9ef">case</span><span style="color:#f92672">(</span>id<span style="color:#f92672">,</span> attr<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>
    <span style="color:#66d9ef">val</span> isPatient <span style="color:#66d9ef">=</span> attr<span style="color:#f92672">.</span>isInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">PatientProperty</span><span style="color:#f92672">]</span>
    <span style="color:#66d9ef">val</span> patient <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>isPatient<span style="color:#f92672">)</span> attr<span style="color:#f92672">.</span>asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">PatientProperty</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">null</span>
    <span style="color:#75715e">// return true iff. isn&#39;t patient or is case patient
</span><span style="color:#75715e"></span>    <span style="color:#f92672">!</span>isPatient <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>scCasePatients<span style="color:#f92672">.</span>value contains patient<span style="color:#f92672">.</span>patientId<span style="color:#f92672">)</span>
  <span style="color:#f92672">})</span>

<span style="color:#75715e">//calculate indegrees and get top vertices
</span><span style="color:#75715e"></span><span style="color:#66d9ef">val</span> top5ComorbidityVertices <span style="color:#66d9ef">=</span> filteredGraph<span style="color:#f92672">.</span>inDegrees<span style="color:#f92672">.</span>
    takeOrdered<span style="color:#f92672">(</span><span style="color:#ae81ff">5</span><span style="color:#f92672">)(</span>scala<span style="color:#f92672">.</span><span style="color:#a6e22e">Ordering</span><span style="color:#f92672">.</span>by<span style="color:#f92672">(-</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>_2<span style="color:#f92672">))</span>
</code></pre></div><p>We have</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">top5ComorbidityVertices<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">org.apache.spark.graphx.VertexId</span>, <span style="color:#66d9ef">Int</span><span style="color:#f92672">)]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Array</span><span style="color:#f92672">((</span><span style="color:#ae81ff">3129</span><span style="color:#f92672">,</span><span style="color:#ae81ff">86</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">335</span><span style="color:#f92672">,</span><span style="color:#ae81ff">63</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">857</span><span style="color:#f92672">,</span><span style="color:#ae81ff">58</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">2048</span><span style="color:#f92672">,</span><span style="color:#ae81ff">49</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">669</span><span style="color:#f92672">,</span><span style="color:#ae81ff">48</span><span style="color:#f92672">))</span>
</code></pre></div><p>And we can check the vertex of index 3129 in original graph is</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">scala<span style="color:#f92672">&gt;</span> graph<span style="color:#f92672">.</span>vertices<span style="color:#f92672">.</span>filter<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>_1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">3129</span><span style="color:#f92672">).</span>collect
<span style="color:#a6e22e">Array</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">org.apache.spark.graphx.VertexId</span>, <span style="color:#66d9ef">VertexProperty</span><span style="color:#f92672">)]</span> <span style="color:#66d9ef">=</span> 
<span style="color:#a6e22e">Array</span><span style="color:#f92672">((</span><span style="color:#ae81ff">3129</span><span style="color:#f92672">,</span><span style="color:#a6e22e">DiagnosticProperty</span><span style="color:#f92672">(</span><span style="color:#a6e22e">DIAG4019</span><span style="color:#f92672">)))</span>
</code></pre></div><p>The 4019 code correponds to <a href="http://www.hipaaspace.com/Medical_Billing/Coding/ICD-9/Diagnosis/4019">Hypertension</a>, which is reasonable.</p>
<h3 id="similar-patients">Similar patients</h3>
<p>Given a patient diagnostic graph, we can also find similar patients. One of the most straightforward approach is shortest path on the graph.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> sssp <span style="color:#66d9ef">=</span> graph<span style="color:#f92672">.</span>
  mapVertices<span style="color:#f92672">((</span>id<span style="color:#f92672">,</span> <span style="color:#66d9ef">_</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>id <span style="color:#f92672">==</span> <span style="color:#ae81ff">0L</span><span style="color:#f92672">)</span> <span style="color:#ae81ff">0.0</span> <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">Double</span><span style="color:#f92672">.</span><span style="color:#a6e22e">PositiveInfinity</span><span style="color:#f92672">).</span>
  pregel<span style="color:#f92672">(</span><span style="color:#a6e22e">Double</span><span style="color:#f92672">.</span><span style="color:#a6e22e">PositiveInfinity</span><span style="color:#f92672">)(</span>
    <span style="color:#f92672">(</span>id<span style="color:#f92672">,</span> dist<span style="color:#f92672">,</span> newDist<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> math<span style="color:#f92672">.</span>min<span style="color:#f92672">(</span>dist<span style="color:#f92672">,</span> newDist<span style="color:#f92672">),</span> <span style="color:#75715e">// Vertex Program
</span><span style="color:#75715e"></span>    triplet <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">{</span>  <span style="color:#75715e">// Send Message
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">var</span> msg<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Iterator</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">org.apache.spark.graphx.VertexId</span>, <span style="color:#66d9ef">Double</span><span style="color:#f92672">)]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Iterator</span><span style="color:#f92672">.</span>empty
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>triplet<span style="color:#f92672">.</span>srcAttr <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;</span> triplet<span style="color:#f92672">.</span>dstAttr<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        msg <span style="color:#66d9ef">=</span> msg <span style="color:#f92672">++</span> <span style="color:#a6e22e">Iterator</span><span style="color:#f92672">((</span>triplet<span style="color:#f92672">.</span>dstId<span style="color:#f92672">,</span> triplet<span style="color:#f92672">.</span>srcAttr <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">))</span>
      <span style="color:#f92672">}</span>

      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>triplet<span style="color:#f92672">.</span>dstAttr <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;</span> triplet<span style="color:#f92672">.</span>srcAttr<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        msg <span style="color:#66d9ef">=</span> msg <span style="color:#f92672">++</span> <span style="color:#a6e22e">Iterator</span><span style="color:#f92672">((</span>triplet<span style="color:#f92672">.</span>srcId<span style="color:#f92672">,</span> triplet<span style="color:#f92672">.</span>dstAttr <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">))</span>
      <span style="color:#f92672">}</span>
      println<span style="color:#f92672">(</span>msg<span style="color:#f92672">)</span>
      msg
    <span style="color:#f92672">},</span>
    <span style="color:#f92672">(</span>a<span style="color:#f92672">,</span>b<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> math<span style="color:#f92672">.</span>min<span style="color:#f92672">(</span>a<span style="color:#f92672">,</span>b<span style="color:#f92672">)</span> <span style="color:#75715e">// Merge Message
</span><span style="color:#75715e"></span>  <span style="color:#f92672">)</span>

<span style="color:#75715e">// get top 5 most similar
</span><span style="color:#75715e"></span>sssp<span style="color:#f92672">.</span>vertices<span style="color:#f92672">.</span>filter<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>_2 <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">Double</span><span style="color:#f92672">.</span><span style="color:#a6e22e">PositiveInfinity</span><span style="color:#f92672">).</span>
    filter<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>_1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">300</span><span style="color:#f92672">).</span>
    takeOrdered<span style="color:#f92672">(</span><span style="color:#ae81ff">5</span><span style="color:#f92672">)(</span>scala<span style="color:#f92672">.</span><span style="color:#a6e22e">Ordering</span><span style="color:#f92672">.</span>by<span style="color:#f92672">(-</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>_2<span style="color:#f92672">))</span>
</code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#basic-concept">Basic concept</a></li>
    <li><a href="#graph-construction">Graph construction</a>
      <ul>
        <li><a href="#define-class">Define class</a></li>
        <li><a href="#load-raw-data">Load raw data</a></li>
        <li><a href="#create-vertex">Create vertex</a></li>
        <li><a href="#create-edge">Create edge</a></li>
        <li><a href="#assemble-vertex-and-edge">Assemble vertex and edge</a></li>
      </ul>
    </li>
    <li><a href="#graph-operation">Graph operation</a>
      <ul>
        <li><a href="#connected-components">Connected components</a></li>
        <li><a href="#degree">Degree</a></li>
        <li><a href="#pagerank">PageRank</a></li>
      </ul>
    </li>
    <li><a href="#application">Application</a>
      <ul>
        <li><a href="#explore-comorbidities">Explore comorbidities</a></li>
        <li><a href="#similar-patients">Similar patients</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












