<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Spark Gotchas ::: tip Learning Objectives
 Understanding runtime pitfalls that may arise  :::
::: danger
This doc is required to be updated.
:::
Overview Spark has a handful of gotchas that exist while running in any clustered environment (standalone, K8s, Mesos, Yarn) which can cause runtime issues late in the execution of a job depending how it is coded. It is better to know of these pitfalls ahead of time as the scala compiler will not alert you of them as syntactically your code may be perfect."><meta property="og:title" content="" />
<meta property="og:description" content="Spark Gotchas ::: tip Learning Objectives
 Understanding runtime pitfalls that may arise  :::
::: danger
This doc is required to be updated.
:::
Overview Spark has a handful of gotchas that exist while running in any clustered environment (standalone, K8s, Mesos, Yarn) which can cause runtime issues late in the execution of a job depending how it is coded. It is better to know of these pitfalls ahead of time as the scala compiler will not alert you of them as syntactically your code may be perfect." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/sections/spark-gotchas/" />

<title>Spark Gotchas | GT Big Data Bootcamp</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.63eb88daa545365405ecdbb21033286a325c60a36cfa6d22d21e7c3bc9286941.css" integrity="sha256-Y&#43;uI2qVFNlQF7NuyEDMoajJcYKNs&#43;m0i0h58O8koaUE=">


<script defer src="/en.search.min.02e7b0823ad8dc02444c3cf834999439728ff3cbbc9a2ab0061f1409d34848fa.js" integrity="sha256-AuewgjrY3AJETDz4NJmUOXKP88u8miqwBh8UCdNISPo="></script>

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>GT Big Data Bootcamp</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  

  
  





 
  
    




  
  <ul>
    
      
        

  <li class="book-section-flat" >
    

  
  <a href="/docs/example/" class="">Example Site</a>
  


    




  
  <ul>
    
      
        

  <li>
    

  
  <a href="/docs/example/table-of-contents/" class="">Table of Contents</a>
  


    




  
  <ul>
    
      
        <li>

  
  <a href="/docs/example/table-of-contents/with-toc/" class="">With ToC</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/example/table-of-contents/without-toc/" class="">Without ToC</a>
  

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li>
    

  
  <a href="/docs/example/collapsed/" class="collapsed ">Collapsed</a>
  


    






  </li>


      
    
  </ul>
  



  </li>


      
    
      
        

  <li class="book-section-flat" >
    

  
  <span>Shortcodes</span>
  


    




  
  <ul>
    
      
        <li>

  
  <a href="/docs/shortcodes/buttons/" class="">Buttons</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/shortcodes/columns/" class="">Columns</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/shortcodes/expand/" class="">Expand</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/shortcodes/hints/" class="">Hints</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/shortcodes/katex/" class="">Katex</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/shortcodes/mermaid/" class="">Mermaid</a>
  

</li>
      
    
      
        <li>

  
  <a href="/docs/shortcodes/tabs/" class="">Tabs</a>
  

</li>
      
    
  </ul>
  



  </li>


      
    
  </ul>
  



  
















</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Spark Gotchas</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="spark-gotchas">Spark Gotchas</h1>
<p>::: tip Learning Objectives</p>
<ul>
<li>Understanding runtime pitfalls that may arise</li>
</ul>
<p>:::</p>
<p>::: danger</p>
<p>This doc is required to be updated.</p>
<p>:::</p>
<h2 id="overview">Overview</h2>
<p>Spark has a handful of gotchas that exist while running in any clustered environment (standalone, K8s, Mesos, Yarn) which can cause runtime issues
late in the execution of a job depending how it is coded.  It is better to know of these pitfalls ahead of time as the scala compiler will not alert you of them as syntactically your code may be perfect.</p>
<p><strong>Member Serialization</strong></p>
<p>The following is a remarkably unrealistic example as <em>why would you not just create the variable in the main?</em>.<br>
However, there are instances when sub-classing that you may want to override values that are a member
of the base.  In that, it should be known serialization issues can arise.  Spark serializes entire objects with their
initial state to workers but deal with implicits differently &ndash; it&rsquo;s always better to declare and initialize variables that will <em>not</em>
change locally in the call stack from <em>main()</em>.<br>
<em>Note:</em> Spark uses closures to defined execution strategies but these closures do not operate in the same fashion as in Scala itself.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span><span style="color:#f92672">(</span>x<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span>

<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">ObjectMemberIssue</span> <span style="color:#f92672">{</span>

	<span style="color:#75715e">// When foo is accessed via a map operation (transformation) on a worker
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// it will be null
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> foo<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>

	<span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span> <span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>

		<span style="color:#66d9ef">val</span> session <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">SparkSession</span><span style="color:#f92672">.</span>builder<span style="color:#f92672">().</span>appName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;foo&#34;</span><span style="color:#f92672">).</span>getOrCreate<span style="color:#f92672">()</span>

		foo <span style="color:#66d9ef">=</span> <span style="color:#e6db74">&#34;bar&#34;</span>

		<span style="color:#66d9ef">import</span> session.implicits._

		<span style="color:#66d9ef">val</span> dsOfStrings <span style="color:#66d9ef">=</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> to <span style="color:#ae81ff">100</span><span style="color:#f92672">).</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Test</span><span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>toString<span style="color:#f92672">)).</span>toDS<span style="color:#f92672">()</span>

		<span style="color:#75715e">// This will produce a NullPointerException on the worker which will
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// cause it to die if the job is not running in local mode in the same JVM
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// as the driver.  In cluster mode (standalone or otherwise) MemberIssue
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// will be serialized in its default state to the worker causing 
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// the access of foo and the append to x to produce the NPE
</span><span style="color:#75715e"></span>		dsOfStrings<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>i <span style="color:#66d9ef">=&gt;</span> i<span style="color:#f92672">.</span>copy<span style="color:#f92672">(</span>i<span style="color:#f92672">.</span>x <span style="color:#f92672">++</span> foo<span style="color:#f92672">)).</span>collect<span style="color:#f92672">().</span>foreach<span style="color:#f92672">(</span>println<span style="color:#f92672">)</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>An alternative solution is to use an implicit val:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">
<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">ObjectMemberIssueSolution</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">var</span> foo<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>

	<span style="color:#75715e">// implicits are searched for and are contexually bound for serialization
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// at runtime time but are intrinsically value structures and will not change
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">def</span> append<span style="color:#f92672">(</span>base<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)(</span><span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">val</span> s<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">=</span> base <span style="color:#f92672">++</span> s

	<span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span> <span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>

		<span style="color:#66d9ef">val</span> session <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">SparkSession</span><span style="color:#f92672">.</span>builder<span style="color:#f92672">().</span>appName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;foo&#34;</span><span style="color:#f92672">).</span>getOrCreate<span style="color:#f92672">()</span>

		foo <span style="color:#66d9ef">=</span> <span style="color:#e6db74">&#34;bar&#34;</span>

		<span style="color:#75715e">// implicits are contexual serialized 
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// especially when passed through another method which forces it to be bound
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// in the Spark serializer as the scala compiler guarantees implicits are bound
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// at compile time based upon references
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">val</span> <span style="color:#a6e22e">_foo</span> <span style="color:#66d9ef">=</span> foo

		<span style="color:#66d9ef">import</span> session.implicits._

		<span style="color:#66d9ef">val</span> dsOfStrings <span style="color:#66d9ef">=</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> to <span style="color:#ae81ff">100</span><span style="color:#f92672">).</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Test</span><span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>toString<span style="color:#f92672">)).</span>toDS<span style="color:#f92672">()</span>

		<span style="color:#75715e">// This will produce a NullPointerException on the worker which will
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// cause it to die if the job is not running in local mode in the same JVM
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// as the driver.  In cluster mode (standalone or otherwise) MemberIssue
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// will be serialized in its default state to the worker but b/c the 
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// _foo is an implicit val prior to access subsequent invocations of append will not
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// cause issue.
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// The implicit does not need to be passed as it is automagically wired in via 
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// 
</span><span style="color:#75715e"></span>		dsOfStrings<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>i <span style="color:#66d9ef">=&gt;</span> i<span style="color:#f92672">.</span>copy<span style="color:#f92672">(</span>append<span style="color:#f92672">(</span>i<span style="color:#f92672">.</span>x<span style="color:#f92672">)).</span>collect<span style="color:#f92672">().</span>foreach<span style="color:#f92672">(</span>println<span style="color:#f92672">)</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><strong>Accumulators</strong></p>
<ul>
<li>are write only on the worker (<em>unless running in local mode in the same JVM</em>)</li>
<li>only the driver can read a value of an accumulator or reset the value of the accumlator</li>
</ul>
<p><strong>Broadcast variables</strong></p>
<ul>
<li>are meant to serialize large amounts of data to each worker for fast access.  This data should not change frequently and be relatively static.</li>
<li>data can be reset via <em>unpersist(blocking=True)</em> which will force each worker to delete its cached version of the broadcast variable <em>but</em> the broadcast
will stay in memory for the remaining stage execution.  Upon the next stage execution on the worker the updated state of the broadcast variable will
be re-transmitted.
** an elegant way to handle the eviction of Broadcast data (or accessing of accumulators) is by registering a <em>SparkListener</em> implementation with the <em>SparkSession</em></li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












